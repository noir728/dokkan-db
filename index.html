<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dokkan DB App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-color: #101012;
            --card-bg: #222225;
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            --accent-str: #ff4d4d;
            --accent-teq: #4cd964;
            --accent-agl: #00ccff;
            --accent-int: #ba55d3;
            --accent-phy: #ffa500;
            --border-color: #3a3a3e;
            --highlight: #ffd700;
            --entry-bg: #2a1f30;
            --entry-border: #9c27b0;
            --nav-height: 60px;
        }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-main);
            -webkit-font-smoothing: antialiased; overflow: hidden;
        }

        #app { display: flex; flex-direction: column; height: 100vh; height: 100dvh; }
        #main-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding-bottom: var(--nav-height); position: relative; scroll-behavior: smooth; }

        /* Components */
        .detail-header {
            position: sticky; top: 0; background-color: var(--bg-color); z-index: 100;
            padding: 8px 15px; border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        .header-left { display: flex; align-items: center; gap: 10px; }
        .back-btn { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 5px; }
        .char-name-header { font-size: 14px; font-weight: bold; color: var(--accent-teq); line-height: 1.2; text-shadow: 0 0 5px rgba(76, 217, 100, 0.3); }
        .char-sub-header { font-size: 10px; color: #888; }
        .action-buttons { display: flex; gap: 8px; }
        .icon-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color);
            border-radius: 50%; width: 36px; height: 36px; color: var(--text-sub);
            display: flex; align-items: center; justify-content: center; font-size: 16px;
        }
        .icon-btn.active { color: var(--highlight); border-color: var(--highlight); background: rgba(255, 215, 0, 0.1); }
        .owned-btn.active { color: #4cd964; border-color: #4cd964; background: rgba(76, 217, 100, 0.1); }

        .detail-container { padding: 15px; }
        .section-title {
            font-size: 13px; color: var(--highlight); border-left: 3px solid var(--highlight);
            padding-left: 10px; margin: 25px 0 10px 0; font-weight: bold;
        }
        
        .skill-card {
            background-color: var(--card-bg); border-radius: 8px; padding: 12px; margin-bottom: 15px;
            border: 1px solid var(--border-color); box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .skill-name { font-size: 13px; font-weight: bold; margin-bottom: 8px; color: #8fd3fe; }
        .passive-text { font-size: 12px; line-height: 1.7; white-space: pre-wrap; }
        .passive-bullet { display: block; margin-bottom: 4px; padding-left: 12px; position: relative; }
        .passive-bullet::before { content: "・"; position: absolute; left: 0; color: #888; }
        .hl-num { color: var(--highlight); font-weight: bold; }
        .inline-skill-icon { display: inline-block; height: 16px; width: auto; vertical-align: sub; margin: 0 2px; }
        
        .skill-footer {
            margin-top: 10px; padding-top: 8px; border-top: 1px dashed #555;
            display: flex; justify-content: space-between; font-size: 10px; color: #ffcc00; font-weight: bold;
        }
        .skill-val-item { display: flex; flex-direction: column; align-items: center; }
        .skill-val-label { color: #888; font-size: 9px; margin-bottom: 1px; }

        .embedded-link {
            color: #4cd964; border-bottom: 1px dashed #4cd964; cursor: pointer; font-weight: bold;
        }
        .embedded-link:active { background: rgba(76, 217, 100, 0.2); }

        .entry-effect-box {
            background-color: var(--entry-bg); border: 1px solid var(--entry-border);
            border-radius: 6px; padding: 8px; margin-bottom: 10px;
        }
        .entry-title {
            color: #e0e0e0; font-size: 10px; font-weight: bold; margin-bottom: 4px;
            display: inline-block; background: #9c27b0; padding: 1px 6px; border-radius: 4px;
        }
        
        .super-attack-card {
            background-color: var(--card-bg); border-top: 3px solid #00ccff;
            border-radius: 6px; padding: 10px; margin-bottom: 8px;
        }
        .sa-header { display: flex; align-items: center; margin-bottom: 6px; gap: 8px; }
        .sa-ki-badge {
            background: #333; border: 1px solid #666; color: #fff;
            font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: bold;
        }
        .sa-lv-badge {
            background: #000; border: 1px solid #555; color: #ffd700;
            font-size: 10px; padding: 1px 5px; border-radius: 4px; font-weight: bold;
        }
        .sa-name { font-size: 13px; font-weight: bold; color: #fff; flex: 1; margin-left: 4px; }
        .sa-type { font-size: 10px; padding: 1px 4px; border-radius: 3px; border: 1px solid #555; color: #aaa; }
        .sa-effect { font-size: 11px; color: #ccc; line-height: 1.5; margin-top: 4px; }

        .partner-scroll { display: flex; overflow-x: auto; gap: 12px; padding: 5px 0 10px 0; }
        .partner-item { text-align: center; min-width: 56px; }
        .partner-icon {
            width: 54px; height: 54px; background-color: #333; border-radius: 6px;
            border: 2px solid #555; margin: 0 auto 5px auto; position: relative; overflow: hidden;
        }
        .match-count {
            position: absolute; bottom: 0; right: 0; background-color: #ff4d4d; color: white;
            font-size: 10px; padding: 1px 5px; border-top-left-radius: 6px; font-weight: bold;
        }
        .partner-name {
            font-size: 10px; color: var(--text-sub); overflow: hidden; white-space: nowrap;
            text-overflow: ellipsis; max-width: 56px; margin-top: 2px;
        }

        .scroll-container-x { display: flex; align-items: flex-start; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        
        .medal-step { display: flex; flex-direction: column; align-items: center; min-width: 50px; }
        .medal-icon-box {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, #444, #222);
            border-radius: 6px; margin-bottom: 4px;
            display: flex; align-items: center; justify-content: center;
            font-size: 9px; border: 1px solid #666; position: relative;
            font-weight: bold; color: #888; overflow: hidden;
        }
        .medal-icon-box.eza { background: linear-gradient(135deg, #4a2c00, #222); border-color: #ff8c00; color: #ffae42; }
        .medal-icon-box.seza { background: linear-gradient(135deg, #2a004a, #222); border-color: #d300ff; color: #e080ff; }
        .medal-img { width: 100%; height: 100%; object-fit: contain; }
        .rank-badge { position: absolute; bottom: -2px; right: -2px; background: #000; font-size: 8px; padding: 0 2px; border-radius: 2px; border: 1px solid #555; }
        
        .transition-area { display: flex; flex-direction: column; align-items: center; justify-content: center; margin-top: 5px; min-width: 50px; }
        .medals-req { display: flex; gap: 2px; margin-bottom: 2px; flex-wrap: wrap; justify-content: center; }
        .req-item { display: flex; flex-direction: column; align-items: center; }
        .req-icon { width: 24px; height: 24px; background: #555; border-radius: 50%; border: 1px solid #777; font-size: 6px; display:flex; align-items:center; justify-content:center; overflow:hidden;}
        .req-count { font-size: 8px; color: #ffd700; margin-top: -4px; background: rgba(0,0,0,0.9); padding: 0 3px; border-radius: 4px; position:relative; z-index:2; }
        .arrow-long { color: #666; font-size: 12px; margin-top: 2px; }

        .farm-card {
            display: flex; flex-direction: column; align-items: center; min-width: 60px;
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 6px; padding: 6px; flex-shrink: 0;
        }
        .farm-card-icon {
            width: 40px; height: 40px; background: #333; border-radius: 4px; margin-bottom: 4px;
            display: flex; align-items: center; justify-content: center; font-size: 10px; color: #555;
            border: 1px solid #555; position: relative;
        }
        .farm-card-stage { font-size: 9px; color: var(--text-sub); text-align: center; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
        .farm-card-prob { font-size: 10px; color: #4cd964; font-weight: bold; background: rgba(76, 217, 100, 0.1); padding: 1px 4px; border-radius: 4px; }

        .tab-base {
            display: flex; overflow-x: auto; background-color: #18181b; padding: 8px 5px;
            gap: 8px; border-bottom: 1px solid var(--border-color);
        }
        
        .eza-switch-container {
            display: flex; justify-content: center; padding: 10px; background-color: #1a1a1d;
            border-bottom: 1px solid #333;
        }
        .eza-switch {
            display: flex; background-color: #2d2d30; border-radius: 8px; padding: 3px;
        }
        .eza-switch-item {
            padding: 6px 16px; font-size: 12px; cursor: pointer; border-radius: 6px; color: #888; font-weight: bold;
            transition: all 0.2s;
        }
        .eza-switch-item.active { background-color: #444; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .eza-switch-item.active-eza { background-color: #4a2c00; color: #ffae42; }
        .eza-switch-item.active-seza { background-color: #2a004a; color: #e080ff; }

        .transform-tabs {
            display: flex; overflow-x: auto; background-color: #18181b; padding: 5px 5px 8px 5px;
            gap: 8px; border-bottom: 1px solid var(--border-color);
        }
        .transform-tab-item {
            flex: 0 0 auto; padding: 5px 16px; background-color: var(--card-bg);
            border-radius: 20px; font-size: 12px; color: var(--text-sub); cursor: pointer; border: 1px solid #444;
        }
        .transform-tab-item.active {
            background-color: var(--accent-teq); color: #000; font-weight: bold; border-color: var(--accent-teq);
            box-shadow: 0 0 8px rgba(76, 217, 100, 0.4);
        }

        #tab-bar {
            height: var(--nav-height); background-color: #18181b; border-top: 1px solid var(--border-color);
            position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; align-items: center; z-index: 1000;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .tab-btn {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--text-sub); font-size: 10px; background: none; border: none; width: 100%; height: 100%;
            cursor: pointer;
        }
        .tab-btn.active { color: var(--highlight); }
        .tab-icon { width: 24px; height: 24px; margin-bottom: 4px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }

        .zukan-header {
            padding: 10px 15px; background-color: var(--bg-color); position: sticky; top: 0; z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }
        .search-container { display: flex; gap: 8px; align-items: center; width: 100%; }
        .search-wrapper { position: relative; flex: 1; }
        .search-bar {
            width: 100%; background-color: #2d2d30; border: 1px solid #444; color: white;
            padding: 8px 12px; padding-right: 32px; border-radius: 8px; font-size: 14px;
        }
        .search-clear-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            width: 20px; height: 20px; border-radius: 50%; background: #666; color: white;
            display: none; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; border: none; font-weight: bold;
        }
        .search-clear-btn.visible { display: flex; }

        .action-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 8px; }
        
        .filter-btn {
            background-color: #2d2d30; border: 1px solid #444; color: #ccc;
            border-radius: 8px; padding: 0 12px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; cursor: pointer; height: 36px;
        }
        .filter-btn.active { border-color: var(--highlight); color: var(--highlight); background-color: rgba(255,215,0,0.1); }

        .sort-select-wrapper { flex: 1; height: 36px; }
        .sort-select-main {
            width: 100%; height: 100%; background-color: #2d2d30; border: 1px solid #444; color: white;
            padding: 0 10px; border-radius: 8px; font-size: 11px;
        }

        .mode-switch { display: flex; background-color: #2d2d30; border-radius: 6px; padding: 2px; gap:2px; height: 36px; align-items: center; }
        .mode-btn {
            width: 32px; height: 30px; display: flex; align-items: center; justify-content: center;
            color: #888; border-radius: 4px; cursor: pointer;
        }
        .mode-btn.active { background-color: #444; color: white; }
        .mode-btn svg { width: 16px; height: 16px; fill: currentColor; }

        .active-filter-badge {
            margin-top: 8px; display: inline-flex; align-items: center; gap: 5px;
            background-color: rgba(255, 215, 0, 0.15); color: var(--highlight);
            border: 1px solid rgba(255, 215, 0, 0.3); padding: 4px 10px; border-radius: 20px;
            font-size: 12px; cursor: pointer;
        }

        .char-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; padding: 10px; }
        .char-grid.mode-detail { display: flex; flex-direction: column; gap: 8px; }
        
        /* --- Composite Icon Styles --- */
        .dokkan-icon {
            position: relative; width: 100%; aspect-ratio: 1; overflow: hidden;
            border-radius: 6px; cursor: pointer;
        }
        .icon-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; background-size: cover; background-position: center;
        }
        .layer-char { z-index: 1; }  
        .layer-frame { z-index: 2; border: 0px solid; box-sizing: border-box; }
        
        .layer-rarity { 
            z-index: 3; position: absolute; bottom: 0; left: 0; 
            width: 22px; height: 16px;
            display: flex; align-items: center; justify-content: center;
        }
        .layer-type {
            z-index: 4; position: absolute; top: 0; right: 0; width: 18px; height: 18px;
            display: flex; align-items: center; justify-content: center;
        }
        .layer-status {
            z-index: 5; position: absolute; top: 0; left: 0; display: flex; gap: 1px; padding: 2px;
        }
        /* 極限・超極限アイコン (右下) */
        .layer-eza-status {
            z-index: 5; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            display: flex; align-items: flex-end; justify-content: flex-end; pointer-events: none;
        }
        .eza-icon-img { width: 100%; height: 100%; object-fit: contain; }

        .status-icon { width: 12px; height: 12px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; color: white; border: 1px solid rgba(0,0,0,0.5); }
        .status-owned { background-color: #4cd964; }
        .status-fav { background-color: #ffd700; color: black; }

        .char-item-row .dokkan-icon { width: 50px; height: 50px; flex-shrink: 0; }
        .detail-icon-large { width: 70px; height: 70px; border-radius: 6px; position: relative; }
        .char-row-info { flex: 1; }
        .char-row-name { font-size: 14px; font-weight: bold; line-height: 1.3; margin-bottom: 2px; color: #fff; }
        .char-row-title { font-size: 10px; color: #888; margin-bottom: 2px;}
        .char-row-stats { font-size: 10px; color: #aaa; margin-top: 4px; display: flex; gap: 8px; }
        .clickable-tag { cursor: pointer; transition: opacity 0.2s; }
        .clickable-tag:active { opacity: 0.6; }
        .link-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .link-card { background-color: #2a2a2e; border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; cursor: pointer; transition: background 0.2s; }
        .link-card:active { background-color: #333; border-color: #555; }
        .link-card-name { font-weight: bold; font-size: 11px; margin-bottom: 4px; color: #f0f0f0; }
        .link-card-effect { font-size: 9px; color: #aaa; line-height: 1.3; }
        .link-lbl { color: #666; margin-right: 3px; font-size: 8px; }
        #scroll-top-btn { position: fixed; bottom: 80px; right: 20px; width: 44px; height: 44px; border-radius: 50%; background-color: rgba(255, 215, 0, 0.9); color: #000; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.5); z-index: 900; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        #scroll-top-btn.visible { opacity: 1; pointer-events: auto; }
        .char-cost { font-size: 10px; color: #ffd700; text-align: center; margin-top: 4px; background: rgba(0,0,0,0.6); border-radius: 10px; padding: 2px 6px; border: 1px solid #555; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; align-items: flex-end; }
        .modal-overlay.open { display: flex; }
        .filter-modal { background: #1f1f22; width: 100%; max-height: 85vh; overflow-y: auto; border-top-left-radius: 16px; border-top-right-radius: 16px; padding: 20px; padding-bottom: 40px; box-shadow: 0 -4px 20px rgba(0,0,0,0.5); }
        .filter-section { margin-bottom: 20px; }
        .filter-label { font-size: 12px; font-weight: bold; color: var(--text-sub); margin-bottom: 8px; display: block; }
        .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .filter-chip { padding: 6px 12px; background: #333; border-radius: 20px; font-size: 11px; color: #ccc; border: 1px solid transparent; cursor: pointer; user-select: none; }
        .filter-chip.selected { background: rgba(76, 217, 100, 0.2); color: #4cd964; border-color: #4cd964; }
        .filter-select { width: 100%; background: #333; color: white; padding: 10px; border-radius: 8px; border: 1px solid #444; font-size: 14px; }
        .filter-actions { display: flex; gap: 10px; margin-top: 30px; }
        .btn-reset { flex: 1; padding: 12px; background: #333; color: #aaa; border-radius: 8px; border: none; font-weight: bold; }
        .btn-apply { flex: 2; padding: 12px; background: var(--highlight); color: black; border-radius: 8px; border: none; font-weight: bold; }
        .toggle-group { display: flex; background: #333; border-radius: 8px; pading: 2px; }
        .toggle-item { flex: 1; text-align: center; padding: 8px; font-size: 12px; color: #888; cursor: pointer; border-radius: 6px; }
        .toggle-item.selected { background: #555; color: white; font-weight: bold; }
    </style>
    <script src="js/link_skills.js"></script>
    <script src="js/data.js"></script>
</head>
<body>

<div id="app">
    <div id="main-content"></div>
    <div id="scroll-top-btn" onclick="scrollToTop()">TOP</div>
    
    <!-- Filter Modal -->
    <div id="filter-modal" class="modal-overlay">
        <div class="filter-modal">
            <h2 style="font-size:16px; font-weight:bold; margin-bottom:20px; text-align:center;">絞り込み条件</h2>
            <div class="filter-section"><span class="filter-label">検索条件</span><div class="toggle-group"><div class="toggle-item selected" id="logic-and" onclick="setFilterLogic('AND')">すべて満たす (AND)</div><div class="toggle-item" id="logic-or" onclick="setFilterLogic('OR')">どれか満たす (OR)</div></div></div>
            <div class="filter-section"><span class="filter-label">属性 (Type)</span><div class="filter-chips" id="filter-types"><div class="filter-chip" onclick="toggleFilter('type', 'AGL')">速属性</div><div class="filter-chip" onclick="toggleFilter('type', 'TEQ')">技属性</div><div class="filter-chip" onclick="toggleFilter('type', 'INT')">知属性</div><div class="filter-chip" onclick="toggleFilter('type', 'STR')">力属性</div><div class="filter-chip" onclick="toggleFilter('type', 'PHY')">体属性</div></div></div>
            <div class="filter-section"><span class="filter-label">属性区分 (Class)</span><div class="filter-chips" id="filter-classes"><div class="filter-chip" onclick="toggleFilter('class', 'Super')">超系</div><div class="filter-chip" onclick="toggleFilter('class', 'Extreme')">極系</div></div></div>
            <div class="filter-section"><span class="filter-label">レアリティ</span><div class="filter-chips" id="filter-rarities"><div class="filter-chip" onclick="toggleFilter('rarity', 'LR')">LR</div><div class="filter-chip" onclick="toggleFilter('rarity', 'UR')">UR</div><div class="filter-chip" onclick="toggleFilter('rarity', 'SSR')">SSR</div><div class="filter-chip" onclick="toggleFilter('rarity', 'SR')">SR</div></div></div>
            <div class="filter-section"><span class="filter-label">状態 (Status)</span><div class="filter-chips" id="filter-status"><div class="filter-chip" onclick="toggleFilter('status', 'owned')">所持済み</div><div class="filter-chip" onclick="toggleFilter('status', 'favorite')">お気に入り</div></div></div>
            <div class="filter-section"><span class="filter-label">極限状態</span><div class="filter-chips" id="filter-eza"><div class="filter-chip" onclick="toggleFilter('eza', 'none')">通常</div><div class="filter-chip" onclick="toggleFilter('eza', 'eza')">極限Z覚醒</div><div class="filter-chip" onclick="toggleFilter('eza', 'seza')">超極限</div></div></div>
            <div class="filter-section"><span class="filter-label">必殺技の種類</span><div class="filter-chips" id="filter-sa-type"><div class="filter-chip" onclick="toggleFilter('saType', '気弾')">気弾</div><div class="filter-chip" onclick="toggleFilter('saType', '格闘')">格闘</div><div class="filter-chip" onclick="toggleFilter('saType', '物理')">物理</div><div class="filter-chip" onclick="toggleFilter('saType', 'その他')">その他</div></div></div>
            <div class="filter-section"><span class="filter-label">カテゴリ</span><select id="cat-select" class="filter-select" onchange="addFilterFromSelect('category', this)"><option value="">カテゴリを選択...</option></select><div class="filter-chips" id="selected-cats" style="margin-top:10px;"></div></div>
            <div class="filter-section"><span class="filter-label">リンクスキル</span><select id="link-select" class="filter-select" onchange="addFilterFromSelect('link', this)"><option value="">リンクスキルを選択...</option></select><div class="filter-chips" id="selected-links" style="margin-top:10px;"></div></div>
            <div class="filter-actions"><button class="btn-reset" onclick="resetFilters()">リセット</button><button class="btn-apply" onclick="closeFilterModal()">完了</button></div>
        </div>
    </div>

    <div id="tab-bar">
        <button class="tab-btn active" onclick="switchTab('zukan')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg><span style="font-size:10px;">図鑑</span></button>
        <button class="tab-btn" onclick="switchTab('events')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"></path></svg><span style="font-size:10px;">イベント</span></button>
        <button class="tab-btn" onclick="switchTab('party')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M14.5 17.5L3 6V3h3l11.5 11.5"></path><path d="M13 19l6-6"></path><path d="M16 16l4 4"></path><path d="M19 21l2-2"></path></svg><span style="font-size:10px;">編成</span></button>
        <button class="tab-btn" onclick="switchTab('box')"><svg class="tab-icon" viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg><span style="font-size:10px;">BOX</span></button>
    </div>
</div>

<script>
    const DB = (typeof CHARACTER_DATA !== 'undefined') ? CHARACTER_DATA : [];
    const LINKS = (typeof LINK_SKILLS !== 'undefined') ? LINK_SKILLS : {};

    const state = {
        currentTab: 'zukan',
        detailCharId: null,
        detailFormIndex: 0,
        detailEzaMode: 'normal',
        listMode: 'icon',
        owned: [],
        favorites: [],
        searchQuery: '',
        filter: { sort: 'releaseDesc', logic: 'AND', rarities: [], types: [], classes: [], status: [], eza: [], saTypes: [], categories: [], links: [] }
    };

    const contentDiv = document.getElementById('main-content');
    const tabs = document.querySelectorAll('.tab-btn');
    const scrollTopBtn = document.getElementById('scroll-top-btn');
    const filterModal = document.getElementById('filter-modal');
    const RARITY_RANK = { 'LR': 5, 'UR': 4, 'SSR': 3, 'SR': 2, 'R': 1, 'N': 0 };

    function init() {
        const savedOwned = localStorage.getItem('dokkan_owned');
        if(savedOwned) state.owned = JSON.parse(savedOwned);
        const savedFav = localStorage.getItem('dokkan_fav');
        if(savedFav) state.favorites = JSON.parse(savedFav);
        populateFilterOptions();
        render(); 
        contentDiv.addEventListener('scroll', () => {
            if (contentDiv.scrollTop > 300) scrollTopBtn.classList.add('visible');
            else scrollTopBtn.classList.remove('visible');
        });
    }

    function saveState() {
        localStorage.setItem('dokkan_owned', JSON.stringify(state.owned));
        localStorage.setItem('dokkan_fav', JSON.stringify(state.favorites));
    }

    function populateFilterOptions() {
        const allCats = new Set();
        const allLinks = new Set();
        DB.forEach(c => {
            c.categories?.forEach(cat => allCats.add(cat));
            c.links?.forEach(l => allLinks.add(l)); 
            c.forms?.forEach(f => f.links?.forEach(l => allLinks.add(l)));
        });
        const catSelect = document.getElementById('cat-select');
        Array.from(allCats).sort().forEach(cat => { const op = document.createElement('option'); op.value = cat; op.text = cat; catSelect.appendChild(op); });
        const linkSelect = document.getElementById('link-select');
        Array.from(allLinks).sort().forEach(l => { const op = document.createElement('option'); op.value = l; op.text = l; linkSelect.appendChild(op); });
    }

    function openFilterModal() { filterModal.classList.add('open'); }
    function closeFilterModal() { filterModal.classList.remove('open'); renderZukanList(); }
    function setFilterLogic(logic) { state.filter.logic = logic; document.getElementById('logic-and').classList.toggle('selected', logic === 'AND'); document.getElementById('logic-or').classList.toggle('selected', logic === 'OR'); }
    function setSort(value) { state.filter.sort = value; renderZukanList(); }
    function toggleFilter(key, value) {
        const targetKey = (key === 'rarity') ? 'rarities' : (key === 'class') ? 'classes' : (key === 'type' ? 'types' : (key === 'eza' ? 'eza' : (key === 'status' ? 'status' : 'saTypes')));
        const arr = state.filter[targetKey];
        const idx = arr.indexOf(value);
        if (idx > -1) arr.splice(idx, 1); else arr.push(value);
        updateFilterUI();
    }
    function addFilterFromSelect(type, select) {
        const val = select.value;
        if (!val) return;
        const arr = type === 'category' ? state.filter.categories : state.filter.links;
        if (!arr.includes(val)) arr.push(val);
        select.value = "";
        updateFilterUI();
    }
    function removeArrayFilter(type, value) {
        const arr = type === 'category' ? state.filter.categories : state.filter.links;
        const idx = arr.indexOf(value);
        if (idx > -1) arr.splice(idx, 1);
        updateFilterUI();
    }
    function resetFilters() {
        state.filter = { sort: 'releaseDesc', logic: 'AND', rarities: [], types: [], classes: [], status: [], eza: [], saTypes: [], categories: [], links: [] };
        setFilterLogic('AND');
        document.getElementById('sort-select').value = 'releaseDesc';
        updateFilterUI();
    }
    function updateFilterUI() {
        const updateChips = (containerId, arr) => {
            const container = document.getElementById(containerId);
            Array.from(container.children).forEach(chip => {
                const match = chip.getAttribute('onclick').match(/'([^']+)'\)$/);
                if (match) { const val = match[1]; chip.classList.toggle('selected', arr.includes(val)); }
            });
        };
        updateChips('filter-rarities', state.filter.rarities);
        updateChips('filter-types', state.filter.types);
        updateChips('filter-classes', state.filter.classes);
        updateChips('filter-status', state.filter.status);
        updateChips('filter-eza', state.filter.eza);
        updateChips('filter-sa-type', state.filter.saTypes);
        const catContainer = document.getElementById('selected-cats');
        catContainer.innerHTML = '';
        state.filter.categories.forEach(c => { const chip = document.createElement('div'); chip.className = 'filter-chip selected'; chip.innerText = c + ' ×'; chip.onclick = () => removeArrayFilter('category', c); catContainer.appendChild(chip); });
        const linkContainer = document.getElementById('selected-links');
        linkContainer.innerHTML = '';
        state.filter.links.forEach(l => { const chip = document.createElement('div'); chip.className = 'filter-chip selected'; chip.innerText = l + ' ×'; chip.onclick = () => removeArrayFilter('link', l); linkContainer.appendChild(chip); });
    }

    function applyFilter(type, value) {
        state.filter = { sort:'releaseDesc', logic: 'AND', rarities: [], types: [], classes: [], status: [], eza: [], saTypes: [], categories: [], links: [] };
        state.searchQuery = '';
        if (type === 'name') state.searchQuery = value;
        else if (type === 'category') state.filter.categories = [value];
        else if (type === 'link') state.filter.links = [value];
        updateFilterUI();
        state.detailCharId = null;
        state.currentTab = 'zukan';
        updateTabUI();
        render(); 
        scrollToTop();
    }
    function clearSearch() { state.searchQuery = ''; document.getElementById('zukan-search-input').value = ''; renderZukanList(); }
    function switchTab(tabName) { state.currentTab = tabName; state.detailCharId = null; updateTabUI(); render(); }
    function updateTabUI() {
        tabs.forEach(t => t.classList.remove('active'));
        const activeBtn = document.querySelector(`button[onclick="switchTab('${state.currentTab}')"]`);
        if(activeBtn) activeBtn.classList.add('active');
    }
    function scrollToTop() { contentDiv.scrollTo({ top: 0, behavior: 'smooth' }); }

    function getCharIconHtml(char) {
        let typeColor = getAttributeColor(char.type);
        const isOwned = state.owned.includes(char.id);
        const isFav = state.favorites.includes(char.id);
        const imgHtml = `<img src="assets/images/${char.id}.png" class="icon-layer layer-char" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="icon-layer layer-char" style="display:none;align-items:center;justify-content:center;color:#555;font-size:10px;background:#333;">IMG</div>`;
        const frameSrc = `assets/frames/${char.rarity}_${char.type}.png`;
        const frameHtml = `<img src="${frameSrc}" class="icon-layer layer-frame" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'"><div class="icon-layer layer-frame" style="display:none; border: 2px solid ${typeColor}; box-sizing:border-box;"></div>`;
        const raritySrc = `assets/rarities/${char.rarity}.png`;
        const rarityHtml = `<img src="${raritySrc}" class="layer-rarity" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="layer-rarity" style="display:none; background:${getRankColor(char.rarity)};">${char.rarity}</div>`;
        const typeSrc = `assets/types/${char.type}.png`;
        const typeHtml = `<img src="${typeSrc}" class="layer-type" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="layer-type" style="display:none; background:${typeColor};">${getShortType(char.type)}</div>`;
        let statusHtml = '';
        if (isOwned || isFav) {
            statusHtml = '<div class="layer-status">';
            if(isFav) statusHtml += '<div class="status-icon status-fav">★</div>';
            if(isOwned) statusHtml += '<div class="status-icon status-owned">✔</div>';
            statusHtml += '</div>';
        }
        
        // EZA Icons
        let ezaHtml = '';
        if (char.seza) { // Super EZA
             ezaHtml = `<div class="layer-eza-status"><img src="assets/status/seza.png" class="eza-icon-img"></div>`;
        } else if (char.eza) { // EZA
             ezaHtml = `<div class="layer-eza-status"><img src="assets/status/eza.png" class="eza-icon-img"></div>`;
        }

        return `<div class="dokkan-icon">${imgHtml}${frameHtml}${rarityHtml}${typeHtml}${statusHtml}${ezaHtml}</div>`;
    }
    function getRankColor(r) { return (r==='LR') ? 'linear-gradient(45deg, #ff0000, #ffff00)' : (r==='UR') ? '#ff8c00' : '#aaa'; }
    function getShortType(t) { return t ? (t==='AGL'?'速':t==='TEQ'?'技':t==='INT'?'知':t==='STR'?'力':'体') : '?'; }
    function getAttributeColor(t) { return t ? (t==='AGL'?'#00ccff':t==='TEQ'?'#4cd964':t==='INT'?'#ba55d3':t==='STR'?'#ff4d4d':'#ffa500') : '#888'; }
    function parsePassiveText(text) {
        if(!text) return "";
        let formatted = text.replace(/\[img:([^\]]+)\]/g, '<img src="assets/skills/$1.png" class="inline-skill-icon" onerror="this.style.display=\'none\'">');
        return formatted.split('\n').map(line => `<span class="passive-bullet">${line}</span>`).join('');
    }
    function formatText(text) {
        if (!text) return "";
        return text.replace(/([0-9]+%?|\+[0-9]+)/g, '<span class="hl-num">$1</span>').replace(/名称に「([^」]+)」/g, '名称に<span class="embedded-link" onclick="applyFilter(\'name\', \'$1\')">「$1」</span>').replace(/「([^」]+)」/g, '<span class="embedded-link" onclick="applyFilter(\'category\', \'$1\')">「$1」</span>').replace(/\n/g, '<br>');
    }

    function render() {
        contentDiv.innerHTML = '';
        if (state.detailCharId) { renderCharacterDetail(state.detailCharId); return; }
        if (state.currentTab === 'zukan') renderZukanLayout();
        else contentDiv.innerHTML = `<div style="padding:20px;text-align:center;color:#888;">${state.currentTab} (開発中)</div>`;
    }

    function renderZukanLayout() {
        let header = document.getElementById('zukan-header-el');
        if (!header) {
            header = document.createElement('div');
            header.id = 'zukan-header-el';
            header.className = 'zukan-header';
            header.innerHTML = `
                <div class="search-container"><div class="search-wrapper"><input type="text" id="zukan-search-input" class="search-bar" placeholder="名前、二つ名で検索..." value="${state.searchQuery}"><button id="search-clear-btn" class="search-clear-btn" onclick="clearSearch()">×</button></div></div>
                <div class="action-row"><button id="zukan-filter-btn" class="filter-btn" onclick="openFilterModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right:4px;"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>絞り込み<span id="filter-badge" style="display:none; background:var(--highlight);color:black;font-size:10px;padding:2px 5px;border-radius:10px;margin-left:4px;"></span></button><div class="sort-select-wrapper"><select id="sort-select" class="sort-select-main" onchange="setSort(this.value)"><option value="releaseDesc">実装日: 新しい順</option><option value="releaseAsc">実装日: 古い順</option><option value="rarityDesc">レアリティ: 高い順</option><option value="rarityAsc">レアリティ: 低い順</option><option value="costDesc">コスト: 高い順</option><option value="costAsc">コスト: 低い順</option><option value="hpDesc">HP: 高い順</option><option value="atkDesc">ATK: 高い順</option><option value="defDesc">DEF: 高い順</option></select></div><div class="mode-switch"><div class="mode-btn ${state.listMode === 'icon' ? 'active' : ''}" onclick="setListMode('icon')"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M4 4h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 10h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4zM4 16h4v4H4zm6 0h4v4h-4zm6 0h4v4h-4z"/></svg></div><div class="mode-btn ${state.listMode === 'detail' ? 'active' : ''}" onclick="setListMode('detail')"><svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg></div></div></div><div class="text-xs text-gray-500" id="zukan-count" style="margin-top:4px; text-align:right;">---</div>
            `;
            header.querySelector('input').addEventListener('input', (e) => { state.searchQuery = e.target.value; renderZukanList(); });
            contentDiv.appendChild(header);
            const grid = document.createElement('div');
            grid.id = 'zukan-grid';
            contentDiv.appendChild(grid);
        }
        renderZukanList();
    }

    function renderZukanList() {
        const f = state.filter;
        const query = state.searchQuery.toLowerCase();
        const clrBtn = document.getElementById('search-clear-btn');
        if(clrBtn) state.searchQuery ? clrBtn.classList.add('visible') : clrBtn.classList.remove('visible');

        let displayDB = DB.filter(char => {
            if (query && !char.name.toLowerCase().includes(query) && !char.title?.includes(query)) return false;
            if (f.rarities.length && !f.rarities.includes(char.rarity)) return false;
            if (f.types.length && !f.types.includes(char.type)) return false;
            if (f.classes.length && !f.classes.includes(char.class)) return false;
            if (f.status.includes('owned') && !state.owned.includes(char.id)) return false;
            if (f.status.includes('favorite') && !state.favorites.includes(char.id)) return false;
            if (f.eza.length > 0) {
                let isEza = char.eza || char.awakening?.some(a => a.rank === 'EZA');
                let isSeza = char.awakening?.some(a => a.rank === 'SEZA');
                let match = false;
                if (f.eza.includes('none') && !isEza) match = true;
                if (f.eza.includes('eza') && isEza && !isSeza) match = true;
                if (f.eza.includes('seza') && isSeza) match = true;
                if(!match) return false;
            }
            if (f.categories.length > 0) {
                const hasCat = (c) => char.categories?.includes(c);
                if (f.logic === 'AND' && !f.categories.every(hasCat)) return false;
                if (f.logic === 'OR' && !f.categories.some(hasCat)) return false;
            }
            if (f.links.length > 0) {
                const allCharLinks = new Set();
                char.links?.forEach(l => allCharLinks.add(l));
                char.forms?.forEach(frm => frm.links?.forEach(l => allCharLinks.add(l)));
                const hasLink = (l) => allCharLinks.has(l);
                if (f.logic === 'AND' && !f.links.every(hasLink)) return false;
                if (f.logic === 'OR' && !f.links.some(hasLink)) return false;
            }
            if (f.saTypes.length > 0) {
                const allSaTypes = new Set();
                const scanSA = (saList) => saList?.forEach(sa => allSaTypes.add(sa.type));
                scanSA(char.superAttacks);
                char.forms?.forEach(f => scanSA(f.superAttacks));
                char.forms_eza?.forEach(f => scanSA(f.superAttacks));
                if(!f.saTypes.some(t => allSaTypes.has(t))) return false;
            }
            return true;
        });

        if (f.sort) {
             displayDB.sort((a, b) => {
                const getStat = (c, k) => (c.forms && c.forms[0] && c.forms[0].stats && c.forms[0].stats[k]) ? c.forms[0].stats[k] : (c.stats ? c.stats[k] : 0);
                const getRank = (r) => RARITY_RANK[r] !== undefined ? RARITY_RANK[r] : -1;
                if(f.sort === 'releaseDesc') return (b.release||"").localeCompare(a.release||"");
                if(f.sort === 'releaseAsc') return (a.release||"").localeCompare(b.release||"");
                if(f.sort === 'rarityDesc') return getRank(b.rarity) - getRank(a.rarity);
                if(f.sort === 'rarityAsc') return getRank(a.rarity) - getRank(b.rarity);
                if(f.sort === 'costDesc') return (b.cost||0) - (a.cost||0);
                if(f.sort === 'costAsc') return (a.cost||0) - (b.cost||0);
                if(f.sort === 'hpDesc') return getStat(b,'hp') - getStat(a,'hp');
                if(f.sort === 'atkDesc') return getStat(b,'atk') - getStat(a,'atk');
                if(f.sort === 'defDesc') return getStat(b,'def') - getStat(a,'def');
                return 0;
            });
        }

        document.getElementById('zukan-count').innerText = `${displayDB.length}体 表示中`;
        const activeFilterCount = f.rarities.length + f.types.length + f.classes.length + f.status.length + f.eza.length + f.saTypes.length + f.categories.length + f.links.length;
        const badge = document.getElementById('filter-badge');
        const btn = document.getElementById('zukan-filter-btn');
        if(badge && btn) {
            if (activeFilterCount > 0) { badge.style.display = 'inline-block'; badge.innerText = activeFilterCount; btn.classList.add('active'); }
            else { badge.style.display = 'none'; btn.classList.remove('active'); }
        }

        const grid = document.getElementById('zukan-grid');
        if(grid) {
            grid.className = `char-grid ${state.listMode === 'detail' ? 'mode-detail' : ''}`;
            grid.innerHTML = '';
            displayDB.forEach(char => {
                const item = document.createElement('div');
                const iconHtml = getCharIconHtml(char); 
                if (state.listMode === 'icon') {
                    item.className = 'char-item-icon'; item.innerHTML = iconHtml;
                } else {
                    item.className = 'char-item-row';
                    item.innerHTML = `<div style="width:50px;height:50px;flex-shrink:0;">${iconHtml}</div><div class="char-row-info"><div class="char-row-title">${char.title || ''}</div><div class="char-row-name">${char.name.replace(/\n/g, ' ')}</div></div>`;
                }
                item.onclick = () => openDetail(char.id);
                grid.appendChild(item);
            });
        }
    }

    function setListMode(mode) { 
        state.listMode = mode; 
        const btns = document.querySelectorAll('.mode-btn');
        if(btns.length > 0){ btns[0].className = `mode-btn ${mode==='icon'?'active':''}`; btns[1].className = `mode-btn ${mode==='detail'?'active':''}`; }
        renderZukanList();
    }
    
    function openDetail(id) { state.detailCharId = id; state.detailFormIndex = 0; state.detailEzaMode = 'normal'; render(); contentDiv.scrollTop = 0; }
    function closeDetail() { state.detailCharId = null; render(); }
    function setDetailForm(index) { state.detailFormIndex = index; renderCharacterDetail(state.detailCharId); }
    function setEzaMode(mode) { state.detailEzaMode = mode; state.detailFormIndex = 0; renderCharacterDetail(state.detailCharId); }

    function toggleFav(btn, id) {
        if(event) event.stopPropagation();
        if (state.favorites.includes(id)) {
            state.favorites = state.favorites.filter(fid => fid !== id);
            btn.classList.remove('active');
        } else {
            state.favorites.push(id);
            btn.classList.add('active');
        }
        saveState();
    }

    function toggleOwned(btn, id) {
        if(event) event.stopPropagation();
        if (state.owned.includes(id)) {
            state.owned = state.owned.filter(oid => oid !== id);
            btn.classList.remove('active');
        } else {
            state.owned.push(id);
            btn.classList.add('active');
        }
        saveState();
    }

    function renderCharacterDetail(id) {
        contentDiv.innerHTML = ''; 
        const char = DB.find(c => c.id === id);
        if(!char) return;
        
        let targetForms = char.forms;
        if (state.detailEzaMode === 'eza' && char.forms_eza) targetForms = char.forms_eza;
        
        const currentData = (targetForms && targetForms.length > 0 && targetForms[state.detailFormIndex]) ? targetForms[state.detailFormIndex] : char;

        const displayName = (currentData.name || char.name || "").replace(/\n/g, '<br>');
        const displayRawName = (currentData.name || char.name || "").split('\n')[0];

        const container = document.createElement('div');
        
        const header = document.createElement('div');
        header.className = 'detail-header';
        header.innerHTML = `
            <div class="header-left">
                <button class="back-btn" onclick="closeDetail()">←</button>
                <div>
                    <div class="date-info" style="font-size:10px; color:#888; display:flex; gap:5px; margin-bottom:2px;">
                        <span style="border:1px solid #444; padding:1px 4px; border-radius:3px;">実装: ${char.release || '---'}</span>
                        ${char.eza ? `<span style="background:#4a2c00; color:#ffa500; border:1px solid #804000; padding:1px 4px; border-radius:3px;">極限: ${char.eza}</span>` : ''}
                    </div>
                    <div class="char-sub-header">${char.title || ''}</div>
                    <div class="char-name-header clickable-tag" onclick="applyFilter('name', '${displayRawName}')">${displayName}</div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="icon-btn ${state.favorites.includes(id)?'active':''}" onclick="toggleFav(this, ${id})">★</button>
                <button class="icon-btn owned-btn ${state.owned.includes(id)?'active':''}" onclick="toggleOwned(this, ${id})">BOX</button>
            </div>
        `;
        container.appendChild(header);
        
        if (char.forms_eza) {
            const ezaSwitch = document.createElement('div');
            ezaSwitch.className = 'eza-switch-container';
            ezaSwitch.innerHTML = `
                <div class="eza-switch">
                    <div class="eza-switch-item ${state.detailEzaMode === 'normal' ? 'active' : ''}" onclick="setEzaMode('normal')">通常</div>
                    <div class="eza-switch-item ${state.detailEzaMode === 'eza' ? 'active active-eza' : ''}" onclick="setEzaMode('eza')">極限</div>
                </div>`;
            container.appendChild(ezaSwitch);
        }

        if (targetForms && targetForms.length > 0) {
            const tabRow = document.createElement('div');
            tabRow.className = 'transform-tabs';
            targetForms.forEach((form, idx) => {
                const isActive = state.detailFormIndex === idx ? 'active' : '';
                tabRow.innerHTML += `<div class="transform-tab-item ${isActive}" onclick="setDetailForm(${idx})">${form.label || '形態'+(idx+1)}</div>`;
            });
            container.appendChild(tabRow);
        }

        const body = document.createElement('div');
        body.className = 'detail-container';

        // Awakening
        if (char.awakening) {
            let awkHtml = `<div class="section-title" style="margin-top:10px;">覚醒ルート</div><div class="scroll-container-x">`;
            char.awakening.forEach((step, idx) => {
                let boxClass = 'medal-icon-box';
                if (step.rank === 'EZA') boxClass += ' eza'; if (step.rank === 'SEZA') boxClass += ' seza';
                
                let iconContent = step.rank === 'EZA' ? '極' : (step.rank === 'SEZA' ? '超' : 'IMG');
                
                awkHtml += `<div class="medal-step"><div class="${boxClass}">${iconContent}<div class="rank-badge">${step.rank}</div></div></div>`;
                if (idx < char.awakening.length - 1) {
                    const nextStep = char.awakening[idx + 1];
                    if (nextStep.medals) {
                        awkHtml += `<div class="transition-area"><div class="medals-req">`;
                        nextStep.medals.forEach(medal => { 
                            let medalImg = `<img src="assets/medals/${medal.name}.png" class="medal-img" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`;
                            let medalFallback = `<div style="display:none;width:100%;height:100%;align-items:center;justify-content:center;color:#fff;font-size:8px;">M</div>`;
                            awkHtml += `<div class="req-item"><div class="req-icon" title="${medal.name}">${medalImg}${medalFallback}</div><div class="req-count">x${medal.count}</div></div>`; 
                        });
                        awkHtml += `</div><div class="arrow-long">→</div></div>`;
                    } else { awkHtml += `<div class="transition-area"><div class="arrow-long">→</div></div>`; }
                }
            });
            awkHtml += `</div>`;
            body.innerHTML += awkHtml;
        }

        // Stats
        if (currentData.stats) {
            body.innerHTML += `
                <div class="section-title">ステータス</div>
                <div style="display:flex; gap:10px;">
                    <div style="display:flex; flex-direction:column; align-items:center;">
                        <div class="detail-icon-large">${getCharIconHtml(char)}</div>
                        ${char.cost ? `<div class="char-cost">コスト: ${char.cost}</div>` : ''}
                    </div>
                    <table style="width:100%; font-size:11px; text-align:center; border-collapse:collapse; border:1px solid #444; border-radius:4px; overflow:hidden;">
                        <tr style="background:#333; color:#aaa;"><th></th><th>HP</th><th>ATK</th><th>DEF</th></tr>
                        <tr style="background:#222; border-bottom:1px solid #333;"><td style="background:#2a2a2e;font-weight:bold;">LvMax</td><td>${Math.round(currentData.stats.hp*0.8)}</td><td>${Math.round(currentData.stats.atk*0.8)}</td><td>${Math.round(currentData.stats.def*0.8)}</td></tr>
                        <tr style="background:#222; border-bottom:1px solid #333;"><td style="background:#2a2a2e;font-weight:bold;">55%</td><td>${Math.round(currentData.stats.hp*0.9)}</td><td>${Math.round(currentData.stats.atk*0.9)}</td><td>${Math.round(currentData.stats.def*0.9)}</td></tr>
                        <tr style="background:#222;"><td style="background:#2a2a2e;font-weight:bold;">100%</td><td>${currentData.stats.hp}</td><td>${currentData.stats.atk}</td><td>${currentData.stats.def}</td></tr>
                    </table>
                </div>`;
        }

        if (char.leaderSkill) {
            body.innerHTML += `<div class="section-title">リーダースキル</div><div class="skill-card"><div class="passive-text">${formatText(char.leaderSkill)}</div></div>`;
        }

        if (currentData.passive) {
            let content = `<div class="passive-text">${parsePassiveText(currentData.passive.main)}</div>`;
            if (currentData.passive.intro) {
                content = `<div class="entry-effect-box"><div class="entry-title">登場時演出</div><div class="passive-text">${formatText(currentData.passive.intro.condition)}<br>${formatText(currentData.passive.intro.effect)}</div></div>` + content;
            }
            if (currentData.passive.maxValues) {
                content += `<div class="skill-footer"><div class="skill-val-item"><span class="skill-val-label">最大会心</span><span>${currentData.passive.maxValues.crit||'-'}</span></div><div class="skill-val-item"><span class="skill-val-label">最大追撃</span><span>${currentData.passive.maxValues.add||'-'}</span></div><div class="skill-val-item"><span class="skill-val-label">最大回避</span><span>${currentData.passive.maxValues.dodge||'-'}</span></div></div>`;
            }
            body.innerHTML += `<div class="section-title">パッシブスキル</div><div class="skill-card"><div class="skill-name">${currentData.passive.name}</div>${content}</div>`;
        }

        if (currentData.active) {
            body.innerHTML += `<div class="section-title">アクティブスキル</div><div class="skill-card"><div class="skill-name">${currentData.active.name}</div><div class="passive-text"><span style="color:var(--highlight); font-weight:bold;">[条件]</span> ${formatText(currentData.active.condition)}<br><span style="color:var(--highlight); font-weight:bold;">[効果]</span> ${formatText(currentData.active.effect)}</div></div>`;
        }

        if (currentData.superAttacks) {
            body.innerHTML += `<div class="section-title">必殺技</div>`;
            currentData.superAttacks.forEach(sa => {
                let color = (sa.ki && sa.ki.includes("18")) ? "#ff4d4d" : "#00ccff";
                body.innerHTML += `<div class="super-attack-card" style="border-top-color: ${color};"><div class="sa-header"><span class="sa-ki-badge" style="background:${color};">気力 ${sa.ki || '12'}</span>${sa.maxLv ? `<span class="sa-lv-badge">Lv${sa.maxLv}</span>` : ''}<span class="sa-name">${sa.name}</span><span class="sa-type">${sa.type}</span></div><div class="sa-effect">${formatText(sa.effect)}</div></div>`;
            });
        }

        if (char.categories) {
            body.innerHTML += `<div class="section-title">カテゴリ</div><div style="display:flex; flex-wrap:wrap; gap:6px;">`;
            char.categories.forEach(cat => { body.innerHTML += `<span class="clickable-tag" onclick="applyFilter('category', '${cat}')" style="background:#333; padding:4px 10px; border-radius:12px; font-size:10px; border:1px solid #555;">${cat}</span>`; });
            body.innerHTML += `</div>`;
        }

        if (currentData.links) {
            body.innerHTML += `<div class="section-title">リンクスキル</div><div class="link-grid">`;
            currentData.links.forEach(linkName => {
                const effectData = LINKS[linkName] || { lv1: "---", lv10: "---" };
                body.innerHTML += `<div class="link-card" onclick="applyFilter('link', '${linkName}')"><div class="link-card-name">${linkName}</div><div><span class="link-lbl">Lv1</span><span class="link-card-effect">${formatText(effectData.lv1)}</span></div><div style="margin-top:2px;"><span class="link-lbl">Lv10</span><span class="link-card-effect">${formatText(effectData.lv10)}</span></div></div>`;
            });
            body.innerHTML += `</div>`;
        }
        
        if (char.partners) {
            let partnersHtml = '';
            char.partners.forEach(p => {
                let typeColor = getAttributeColor(p.type);
                partnersHtml += `<div class="partner-item"><div class="partner-icon" style="border-color:${typeColor}"><div class="img-placeholder">IMG</div><div class="match-count">${p.match}</div></div><div class="partner-name">${p.name}</div></div>`;
            });
            body.innerHTML += `<div class="section-title">相性の良いキャラ</div><div class="partner-scroll">${partnersHtml}</div>`;
        }

        if (char.farmCards) {
            body.innerHTML += `<div class="section-title">技上げ素材</div><div class="scroll-container-x">`;
            char.farmCards.forEach(card => { body.innerHTML += `<div class="farm-card"><div class="farm-card-icon">IMG<div class="rank-badge">${card.rarity}</div></div><div class="farm-card-stage">${card.stage}</div><div class="farm-card-prob">${card.prob}</div></div>`; });
            body.innerHTML += `</div>`;
        }

        container.appendChild(body);
        contentDiv.appendChild(container);
    }

    init();
</script>
</body>
</html>